<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="assets/css/style.css">

    <title>Giphy Project</title>
</head>

<body>

    <div class="container">
        <header>
            <h1>Gif Time!</h1>
        </header>

        <!-- Rendered buttons will get dumped Here  -->
        <div class="row" id="button-to-make-gifs">
            <div id="buttons-view"></div>
        </div>

        <div class="row" id="app-control">
            <form id="gif-form">
                <div class="form-group">
                    <label for="gif-input">Choose a gif</label>
                    <input type="text" class="form-control" id="gif-input">
                </div>

                <!-- Button triggers new gif to be added -->
                <button id="add-gif" class="btn btn-primary" type="button">Submit</button>
                <button id="clear-images" class="btn btn-danger" type="button">Clear Image</button>
                <button id="data-toggle" type="button" class="btn btn-primary" data-toggle="off" aria-pressed="false"
                    autocomplete="off" disabled>
                    'Click to allow additional images'
                </button>
            </form>
        </div>

        <div class="row">
            <div class="col-md-6">
                <h3>Found Gifs</h3>
                <div id="gifs-view"></div>
            </div>

            <div class='col-md-6'>
                <h3>Favorite Gifs</h3>
                <div id="favorite"></div>
            </div>

        </div>



        <!-- gifs will get dumped here -->

    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

    <script>
        const API_KEY = 'zB9GX67A68UUQCv1NBX8Rj5XOzCKOTQP';

        const baseQueryURL = `https://api.giphy.com/v1/gifs/search?api_key=${API_KEY}&rating=G`;

        const initialGifTopics = ['penguin', 'star wars', 'funny'];

        let noMoreImages = true;
        let allowAdditionalImages = false;

        // Creates AJAX call for the specific movie search term
        function getGif(searchTerm, limit, callback) {
            const queryURL = baseQueryURL + '&q=' + searchTerm + '&limit=' + limit;
            $.ajax({
                method: 'GET',
                url: queryURL
            }).then(callback);
        }

        // Toggles gif display between static image and animated gif on gif view click
        function toggleGifDisplay(event) {
            const target = $(event.target);
            if (target.is("img")) {
                const dataState = $(this).attr("data-state");
                let updatedSrc;
                if (dataState === 'still') {
                    updatedSrc = $(this).attr('data-animate');
                    $(this).attr("data-state", 'animated');
                } else {
                    updatedSrc = $(this).attr('data-still');
                    $(this).attr("data-state", 'still');
                }
                $(this).children('.gif-image').attr('src', updatedSrc);
            } else if (target.is('button')) {
                const parent = target.parent();
                const parentClone = parent.clone()
                parentClone.find('button').remove();
                parentClone.appendTo('#favorite');
            }
        }

        function displayGifInfo() {
            if (noMoreImages || allowAdditionalImages) {
                const searchTerm = $(this).attr("data-name");
                getGif(searchTerm, 10, function (response) {
                    response.data.forEach(gif => {
                        // console.log(gif)
                        const stillImageURL = gif.images['fixed_height_still'].url;
                        const animatedGifURL = gif.images['fixed_height'].url;
                        const gifDiv = $('<div class="gif-div text-center">')
                            .attr("data-name", searchTerm)
                            .attr('data-still', stillImageURL)
                            .attr('data-animate', animatedGifURL)
                            .attr('data-state', 'still')

                        const gifImage = $('<img>').addClass('col-md-auto gif-image').attr('src', stillImageURL);
                        const gifTitle = $('<p>').text(gif.title).addClass('gif-info');
                        const rating = $("<p>").text('Rated: ' + gif.rating).addClass('gif-info');
                        const addToFavorites = $('<button type="button" class="btn btn-primary favorite">')
                            .text('Add gif to favorites');
                        gifDiv.append(gifImage, gifTitle, rating, addToFavorites);
                        $('#gifs-view').prepend(gifDiv);
                    });
                });
            }
            $('#data-toggle').attr('disabled', false);
            noMoreImages = false;
        }

        // Creates a gif button if gitTitle is valid and adds the button to buttons-view
        function makeGifButton(gifTitle) {
            const queryURL = baseQueryURL + '&q=' + gifTitle;
            getGif(gifTitle, 1, function (response) {
                // Confirm gif search term exists in Giphy
                if (response.data.length) {
                    const gifButton = $('<button>')
                        .text(gifTitle)
                        .addClass('btn btn-info gif-button')
                        .attr('data-name', gifTitle);
                    $('#buttons-view').append(gifButton);
                } else {
                    alert("The gif term " + gifTitle + " does not exist")
                }
            });
        }

        // Render buttons for initial gif topics
        function renderButtons() {
            initialGifTopics.forEach(gif => {
                makeGifButton(gif);
            });
        }

        // Hangle clicking add gif button
        $("#add-gif").on("click", function () {
            event.preventDefault();
            const gifName = $('#gif-input').val();
            makeGifButton(gifName);
            $('#gif-input').val('');
        });

        // Calling the renderButtons function to display the initial list of gifs
        renderButtons();

        // Adding click event listeners to all elements with a class of "gif"
        $(document).on("click", ".gif-button", displayGifInfo);
        $(document).on("click", ".gif-div", toggleGifDisplay);

        $('#data-toggle').click(function () {
            if ($(this).attr('data-toggle') === 'on') {
                $(this).attr('data-toggle', 'off');
                $(this).text('Click to allow additional images');
                allowAdditionalImages = false;
            } else {
                $(this).attr('data-toggle', 'on')
                allowAdditionalImages = true;
                $(this).text(' Click to prevent additional images');
            }
        });

        $('#clear-images').click(function () {
            $('#gifs-view').empty();
        });

    </script>

</body>

</html>